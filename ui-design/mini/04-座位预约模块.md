# 04 - 座位预约模块

> 状态：📋 规划中  
> 优先级：P0（核心功能）

---

## 4.1 座位选择页 (Seat Select)

### 页面信息
- **页面路径**：`pages/seat/select`
- **页面参数**：`classroomId` - 教室ID

### 核心设计理念

每间教室的布局可以**完全自定义**，后台管理员通过**可视化拖拽编辑器**设计教室布局，前端根据布局数据渲染显示。

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      自习室201 · 选座            │
├─────────────────────────────────────┤
│  ┌─ 日期选择 ─────────────────┐    │
│  │ 今天    明天    后天    12/07   │    │
│  │ 12/04  12/05  12/06  周六     │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 时段选择 ─────────────────┐    │
│  │ 上午场     下午场     晚间场    │    │
│  │ 08-12    14-18    19-22      │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 图例说明 ─────────────────┐    │
│  │ 🟢 可选              🔴 不可选 │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌───────── 教室布局图───────────┐    │
│  │                             │    │
│  │  ╭───╮ ╭───╮ ╭───╮       │    │
│  │  │🚪│ │   │ │   │       │    │
│  │  │门 │ │讲台│ │   │       │    │
│  │  ╰───╯ ╰───╯ ╰───╯       │    │
│  │                             │    │
│  │  ╭───╮ ╭───╮ ╭───╮ ╭───╮ │    │
│  │  │🟢│  │🔴│  │🔴│ │🟢│ │    │
│  │  │01│  │02│   │03│  │04│ │    │
│  │  ╰───╯ ╰───╯ ╰───╯ ╰───╯ │    │
│  │                             │    │
│  │  ╭───╮ ╭───╮ ╭───╮ ╭───╮ │    │
│  │  │🟢│  │🔴│  │🔴│  │🟢│ │    │
│  │  │05│  │06│   │07│  │08│ │    │
│  │  ╰───╯ ╰───╯ ╰───╯ ╰───╯ │    │
│  │                             │    │
│  │  ╭───╮ ╭───╮ ╭───╮ ╭───╮ │    │
│  │  │🔴│  │🟢│  │🟢│  │🔴│ │    │
│  │  │09│   │10│  │11│ │12│ │    │
│  │  ╰───╯ ╰───╯ ╰───╯ ╰───╯ │    │
│  │                             │    │
│  │  ╭───╮             ╭───╮ │    │
│  │  │🪟│             │🪟│ │    │
│  │  │窗 │             │窗 │ │    │
│  │  ╰───╯             ╰───╯ │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 已选座位 ─────────────────┐    │
│  │ 座位号：09号                 │    │
│  │ 设施：🔌 有电源              │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         确认选座              │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 布局元素类型

| 元素类型 | 图标示例 | 说明 | 是否可预约 |
|----------|----------|------|----------|
| 座位 | 🪑 | 可预约的学习座位 | ✅ 是 |
| 门 | 🚪 | 教室入口 | ❌ 否 |
| 窗户 | 🪟 | 窗户位置 | ❌ 否 |
| 讲台 | 📝 | 讲台/讲桌 | ❌ 否 |
| 走廊 | ⬜ | 过道/走廊 | ❌ 否 |
| 空调 | ❄️ | 空调位置 | ❌ 否 |
| 电源 | 🔌 | 电源插座位置 | ❌ 否 |
| 自定义 | 🎯 | 管理员自定义图标 | 可配置 |

### 座位状态设计

| 状态 | 背景色 | 边框色 | 图标色 | 说明 |
|------|--------|--------|--------|------|
| 可选 | #E8F5E9 | #4CAF50 | #4CAF50 | 绿色系，表示可选择 |
| 已占 | #FFEBEE | #F44336 | #F44336 | 红色系，表示已被占用 |
| 已选 | #FFF3E0 | #FF9800 | #FF9800 | 橙色系，表示当前选中 |
| 不可用 | #F5F5F5 | #BDBDBD | #9E9E9E | 灰色系，表示不可用 |

### 座位卡片结构

```
╭─────────╮
│  图标   │  ← 座位图标（可自定义）
│  状态   │  ← 状态颜色覆盖
├─────────┤
│  座位号  │  ← 座位编号
╰─────────╯
```

### 座位卡片尺寸

| 属性 | 数值 | 说明 |
|------|------|------|
| 宽度 | 80rpx | 座位卡片宽度 |
| 高度 | 100rpx | 座位卡片高度 |
| 图标大小 | 40rpx | 座位图标大小 |
| 座位号字号 | 20rpx | 座位编号字体 |
| 圆角 | 8rpx | 卡片圆角 |
| 间距 | 16rpx | 座位之间间距 |

### 交互说明

1. **日期选择**：
   - 可选择未来7天内的日期
   - 默认选中今天
   - 切换日期后刷新座位状态

2. **时段选择**：
   - 上午场：08:00-12:00
   - 下午场：14:00-18:00
   - 晚间场：19:00-22:00
   - 切换时段后刷新座位状态

3. **座位选择**：
   - 点击可选座位 → 座位变为已选状态
   - 再次点击 → 取消选择
   - 同时只能选择一个座位
   - 只有标记为"座位"类型的元素才可点击选择

4. **布局图交互**：
   - 支持双指缩放
   - 支持拖动平移
   - 长按座位显示座位详情气泡

---

## 4.2 后台布局编辑器（管理端）

### 编辑器界面

```
┌────────────────────────────────────────────────────────────────┐
│  教室布局编辑器 - 自习室201                        保存  预览  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─ 元素库 ─────┐  ┌─ 编辑区域（可拖拽）────────────────────┐  │
│  │             │  │                                        │  │
│  │  🪑 座位    │  │   ╭───╮ ╭───╮ ╭───╮ ╭───╮ ╭───╮    │  │
│  │  🚪 门      │  │   │🚪│ │   │ │📝│ │   │ │   │    │  │
│  │  🪟 窗户    │  │   │门 │ │   │ │讲台│ │   │ │   │    │  │
│  │  📝 讲台    │  │   ╰───╯ ╰───╯ ╰───╯ ╰───╯ ╰───╯    │  │
│  │  ⬜ 走廊    │  │                                        │  │
│  │  ❄️ 空调    │  │   ╭───╮ ╭───╮ ╭───╮ ╭───╮ ╭───╮    │  │
│  │  🔌 电源    │  │   │🪑│ │🪑│ │🪑│ │🪑│ │🪟│    │  │
│  │             │  │   │01│ │02│ │03│ │04│ │窗 │    │  │
│  │ ────────── │  │   ╰───╯ ╰───╯ ╰───╯ ╰───╯ ╰───╯    │  │
│  │ 自定义图标   │  │                                        │  │
│  │             │  │   ╭───╮ ╭───╮ ╭───╮ ╭───╮ ╭───╮    │  │
│  │  上传图标   │  │   │🪑│ │🪑│ │🪑│ │🪑│ │🪟│    │  │
│  │  [选择文件]  │  │   │05│ │06│ │07│ │08│ │窗 │    │  │
│  │             │  │   ╰───╯ ╰───╯ ╰───╯ ╰───╯ ╰───╯    │  │
│  └─────────────┘  │                                        │  │
│                    └────────────────────────────────────────┘  │
│                                                                │
│  ┌─ 属性面板 ───────────────────────────────────────────────┐  │
│  │ 已选中：座位 01                                           │  │
│  │                                                           │  │
│  │ 座位号： [01]        图标： [🪑 ▼]                       │  │
│  │ X坐标：  [120]       Y坐标： [80]                         │  │
│  │ 宽度：   [80]        高度：  [100]                        │  │
│  │ 是否有电源： [☑]     是否靠窗： [☐]                       │  │
│  │ 状态： [正常 ▼]                                           │  │
│  │                                                           │  │
│  │ [删除元素]  [复制元素]  [置顶]  [置底]                    │  │
│  └───────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 编辑器功能说明

#### 元素库
- 拖拽元素到编辑区域添加
- 支持上传自定义图标（PNG/SVG，建议40x40px）
- 可设置元素是否为座位类型

#### 编辑区域
- 网格式布局，支持吸附对齐
- 拖拽移动元素位置
- 拖拽边缘调整元素大小
- 支持多选批量操作
- 支持撤销/重做（Ctrl+Z / Ctrl+Y）
- 支持复制粘贴（Ctrl+C / Ctrl+V）

#### 属性面板
- 选中元素后显示属性
- 可修改坐标、尺寸、图标
- 座位类型可设置额外属性（座位号、电源、靠窗等）
- 可设置座位状态（正常/维护中/停用）

### 布局数据结构

```json
{
  "classroomId": 201,
  "canvasWidth": 800,
  "canvasHeight": 600,
  "elements": [
    {
      "id": "elem_001",
      "type": "seat",
      "seatNo": "01",
      "icon": "🪑",
      "customIcon": null,
      "x": 120,
      "y": 80,
      "width": 80,
      "height": 100,
      "rotation": 0,
      "properties": {
        "hasPower": true,
        "nearWindow": false,
        "status": "normal"
      }
    },
    {
      "id": "elem_002",
      "type": "door",
      "icon": "🚪",
      "x": 40,
      "y": 40,
      "width": 80,
      "height": 100,
      "rotation": 0
    },
    {
      "id": "elem_003",
      "type": "window",
      "icon": "🪟",
      "x": 360,
      "y": 80,
      "width": 80,
      "height": 100,
      "rotation": 0
    }
  ]
}
```

### 元素类型定义

| type | 说明 | 是否可预约 | 必填属性 |
|------|------|----------|----------|
| seat | 座位 | ✅ | seatNo, properties |
| door | 门 | ❌ | - |
| window | 窗户 | ❌ | - |
| podium | 讲台 | ❌ | - |
| corridor | 走廊 | ❌ | - |
| aircon | 空调 | ❌ | - |
| power | 电源 | ❌ | - |
| custom | 自定义 | 可配置 | customIcon |

---

## 4.3 时段选择页 (Time Select)

### 页面信息
- **页面路径**：`pages/time/select`
- **页面参数**：`classroomId`, `seatId`, `date`

### 页面布局（精细时段选择）

```
┌─────────────────────────────────────┐
│  ←      选择预约时段                │
├─────────────────────────────────────┤
│                                     │
│  📅 2024年12月04日 (周三)           │
│  🪑 座位号：17号                    │
│                                     │
│  ─────────── 选择时段 ───────────   │
│                                     │
│  ┌─ 上午 ─────────────────────┐    │
│  │ 08:00  08:30  09:00  09:30  │    │
│  │  🟢    🟢     🟢     🟢    │    │
│  │                             │    │
│  │ 10:00  10:30  11:00  11:30  │    │
│  │  🟢    🟢     🔴     🔴    │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 下午 ─────────────────────┐    │
│  │ 14:00  14:30  15:00  15:30  │    │
│  │  🟢    🟢     🟢     🟢    │    │
│  │                             │    │
│  │ 16:00  16:30  17:00  17:30  │    │
│  │  🟢    🟢     🟢     🟢    │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 晚间 ─────────────────────┐    │
│  │ 19:00  19:30  20:00  20:30  │    │
│  │  🟢    🟢     🟢     🟢    │    │
│  │                             │    │
│  │ 21:00  21:30                │    │
│  │  🟢    🟢                   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 已选时段 ─────────────────┐    │
│  │ 开始：14:00                 │    │
│  │ 结束：18:00                 │    │
│  │ 时长：4小时                  │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         下一步               │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

### 时段选择规则

| 规则 | 说明 |
|------|------|
| 最小单位 | 30分钟 |
| 最短时长 | 1小时 |
| 最长时长 | 4小时（可配置） |
| 连续选择 | 必须选择连续时段 |

### 交互说明

1. **选择开始时间**：点击第一个时段格子
2. **选择结束时间**：点击最后一个时段格子
3. **自动填充**：开始和结束之间的时段自动选中
4. **重新选择**：再次点击已选时段可重新选择

---

## 4.4 预约确认页 (Booking Confirm)

### 页面信息
- **页面路径**：`pages/booking/confirm`
- **页面参数**：预约信息对象

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      确认预约                    │
├─────────────────────────────────────┤
│                                     │
│  ┌─ 预约信息 ─────────────────┐    │
│  │                             │    │
│  │  📍 位置信息                 │    │
│  │  图书馆 · 2F · 自习室201     │    │
│  │                             │    │
│  │  🪑 座位信息                 │    │
│  │  17号座位 · 第3排左侧靠窗    │    │
│  │  🔌 有电源                   │    │
│  │                             │    │
│  │  📅 预约日期                 │    │
│  │  2024年12月04日 (周三)       │    │
│  │                             │    │
│  │  ⏰ 预约时段                 │    │
│  │  14:00 - 18:00 (共4小时)     │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 预约须知 ─────────────────┐    │
│  │ ⚠️ 请在预约开始时间前15分钟  │    │
│  │    内完成签到，否则预约将    │    │
│  │    自动取消并扣除信用分。    │    │
│  │                             │    │
│  │ ⚠️ 如需取消预约，请提前1小时 │    │
│  │    操作，临时取消将扣除信用分│    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 信用积分 ─────────────────┐    │
│  │ 当前信用分：98分             │    │
│  │ 预约后信用分：98分           │    │
│  │ 按时履约可获得：+2分         │    │
│  └─────────────────────────────┘    │
│                                     │
│  ☐ 我已阅读并同意预约规则          │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         确认预约              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 交互说明

1. **确认预约**：
   - 必须勾选同意预约规则
   - 点击确认 → 调用预约接口
   - 预约成功 → 跳转成功页
   - 预约失败 → 显示失败原因

2. **预约失败场景**：
   - 座位已被他人预约
   - 信用分不足
   - 存在未完成的预约
   - 用户在黑名单中

---

## 4.5 预约成功页 (Booking Success)

### 页面信息
- **页面路径**：`pages/booking/success`
- **页面类型**：结果页

### 页面布局

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│            ┌─────────┐              │
│            │   ✓    │              │
│            │  成功   │              │
│            └─────────┘              │
│                                     │
│          预约成功！                  │
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │  📍 图书馆 · 2F · 自习室201  │    │
│  │  🪑 17号座位                 │    │
│  │  📅 2024-12-04 (周三)        │    │
│  │  ⏰ 14:00 - 18:00            │    │
│  │                             │    │
│  │  ─────────────────────────  │    │
│  │                             │    │
│  │  签到时间：13:45 - 14:15     │    │
│  │  请在此时间段内扫码签到       │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │       添加到日历提醒          │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │       查看我的预约            │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         返回首页              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 交互说明

1. **添加日历提醒**：调用系统日历，添加预约提醒事件
2. **查看我的预约**：跳转到我的预约列表页
3. **返回首页**：返回首页TabBar

---

## 4.6 我的预约页 (My Bookings)

### 页面信息
- **页面路径**：`pages/booking/list`
- **页面类型**：列表页

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      我的预约                    │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │ 全部 │ 进行中 │ 已完成 │ 已取消 │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 进行中 ───────────────────┐    │
│  │ 📍 图书馆 · 2F · 自习室201  │    │
│  │ 🪑 17号座位                 │    │
│  │ 📅 今天 14:00 - 18:00       │    │
│  │ 状态：待签到                 │    │
│  │                             │    │
│  │ ┌─────────┐ ┌─────────┐    │    │
│  │ │  取消   │ │ 去签到  │    │    │
│  │ └─────────┘ └─────────┘    │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 已完成 ───────────────────┐    │
│  │ 📍 图书馆 · 3F · 自习室301  │    │
│  │ 🪑 08号座位                 │    │
│  │ 📅 昨天 09:00 - 12:00       │    │
│  │ 状态：已完成 · 学习3小时     │    │
│  │                             │    │
│  │ ┌─────────────────────┐    │    │
│  │ │      再次预约        │    │    │
│  │ └─────────────────────┘    │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 已取消 ───────────────────┐    │
│  │ 📍 教学楼A · 5F · 自习室502 │    │
│  │ 🪑 22号座位                 │    │
│  │ 📅 12-02 14:00 - 18:00      │    │
│  │ 状态：已取消 · 用户取消      │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 预约状态及操作

| 状态 | 可用操作 | 说明 |
|------|----------|------|
| 待签到 | 取消、去签到 | 预约时间前可取消 |
| 使用中 | 临时离开、签退 | 已签到正在使用 |
| 临时离开 | 返回座位 | 暂时离开座位 |
| 已完成 | 再次预约 | 正常完成的预约 |
| 已取消 | 无 | 用户主动取消 |
| 已违约 | 无 | 超时未签到 |

---

## 4.7 预约详情页 (Booking Detail)

### 页面信息
- **页面路径**：`pages/booking/detail`
- **页面参数**：`bookingId` - 预约ID

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      预约详情                    │
├─────────────────────────────────────┤
│                                     │
│  ┌─ 预约状态 ─────────────────┐    │
│  │                             │    │
│  │      🟢 待签到              │    │
│  │   请在 14:15 前完成签到      │    │
│  │                             │    │
│  │      倒计时：02:35:18       │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 预约信息 ─────────────────┐    │
│  │ 预约编号：BK202412040001    │    │
│  │ 预约时间：2024-12-04 10:30  │    │
│  │                             │    │
│  │ 📍 图书馆 · 2F · 自习室201  │    │
│  │ 🪑 17号座位 · 第3排左侧     │    │
│  │ 📅 2024-12-04 (周三)        │    │
│  │ ⏰ 14:00 - 18:00 (4小时)    │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 座位二维码 ───────────────┐    │
│  │                             │    │
│  │      ┌─────────────┐       │    │
│  │      │             │       │    │
│  │      │   二维码    │       │    │
│  │      │             │       │    │
│  │      └─────────────┘       │    │
│  │                             │    │
│  │   到达座位后扫描此码签到     │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         取消预约              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

---

## 4.8 接口依赖

### 小程序端接口

| 接口名称 | 请求方式 | 接口路径 | 说明 |
|----------|----------|----------|------|
| 教室布局 | GET | `/classroom/layout/{id}` | 获取教室布局数据 |
| 座位状态 | GET | `/seat/status` | 获取座位预约状态 |
| 提交预约 | POST | `/appointment/create` | 创建预约 |
| 预约列表 | GET | `/appointment/page` | 获取预约记录 |
| 预约详情 | GET | `/appointment/detail/{id}` | 获取预约详情 |
| 取消预约 | POST | `/appointment/cancel/{id}` | 取消预约 |

### 后台管理端接口

| 接口名称 | 请求方式 | 接口路径 | 说明 |
|----------|----------|----------|------|
| 获取布局 | GET | `/admin/classroom/layout/{id}` | 获取教室布局数据 |
| 保存布局 | POST | `/admin/classroom/layout` | 保存教室布局 |
| 上传图标 | POST | `/admin/classroom/icon/upload` | 上传自定义图标 |
| 图标列表 | GET | `/admin/classroom/icon/list` | 获取自定义图标列表 |
| 删除图标 | DELETE | `/admin/classroom/icon/{id}` | 删除自定义图标 |

---

> 上一篇：[03-自习室浏览模块](./03-自习室浏览模块.md)  
> 下一篇：[05-扫码签到签退模块](./05-扫码签到签退模块.md)
