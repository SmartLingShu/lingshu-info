# 05 - 扫码签到签退模块

> 状态：✅ 已完成  
> 优先级：P0（核心功能）

---

## 5.1 扫码页 (Scan)

### 页面信息
- **页面路径**：`pages/scan/index`
- **页面类型**：TabBar页面
- **权限要求**：相机权限

### 页面布局

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │                             │    │
│  │                             │    │
│  │      ┌───────────────┐      │    │
│  │      │               │      │    │
│  │      │   扫描框      │      │    │
│  │      │   动画边框    │      │    │
│  │      │               │      │    │
│  │      └───────────────┘      │    │
│  │                             │    │
│  │                             │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│        将座位二维码放入框内          │
│        自动识别签到/签退             │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  💡 打开手电筒               │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │  📷 从相册选择               │    │
│  └─────────────────────────────┘    │
│                                     │
├─────────┬─────────┬─────────┬───────┤
│  首页   │  预约   │  扫码   │  我的 │
└─────────┴─────────┴─────────┴───────┘
```

### 页面元素

| 元素 | 说明 | 样式 |
|------|------|------|
| 扫描区域 | 相机预览区域 | 全屏背景 |
| 扫描框 | 识别区域指示 | 500rpx×500rpx，动画边框 |
| 扫描线 | 上下移动的扫描动画 | 主色调渐变 |
| 提示文字 | 操作引导 | 白色，28rpx |
| 手电筒按钮 | 光线不足时使用 | 图标+文字 |
| 相册按钮 | 从相册选择二维码 | 图标+文字 |

### 交互说明

1. **进入页面**：
   - 自动请求相机权限
   - 权限拒绝 → 显示权限引导弹窗

2. **扫码识别**：
   - 识别到二维码 → 震动反馈
   - 解析二维码内容 → 判断操作类型
   - 跳转对应确认页面

3. **手电筒**：
   - 点击开启/关闭手电筒
   - 图标状态同步变化

4. **相册选择**：
   - 打开系统相册
   - 选择图片后识别二维码

---

## 5.2 签到确认页 (Check-in Confirm)

### 页面信息
- **页面路径**：`pages/checkin/confirm`
- **页面参数**：`seatCode` - 座位二维码内容

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      签到确认                    │
├─────────────────────────────────────┤
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │  📍 位置信息                 │    │
│  │  图书馆 · 2F · 自习室201     │    │
│  │                             │    │
│  │  🪑 座位信息                 │    │
│  │  17号座位                    │    │
│  │                             │    │
│  │  📅 预约信息                 │    │
│  │  2024-12-04 14:00 - 18:00   │    │
│  │                             │    │
│  │  ⏰ 当前时间                 │    │
│  │  13:58:32                   │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 签到须知 ─────────────────┐    │
│  │ • 签到后请在座位上学习       │    │
│  │ • 临时离开请点击"临时离开"   │    │
│  │ • 离开超过30分钟将自动签退   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         确认签到              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 签到状态判断

| 场景 | 判断条件 | 处理方式 |
|------|----------|----------|
| 正常签到 | 在签到时间窗口内 | 显示确认页面 |
| 提前签到 | 早于签到开始时间 | 提示"签到时间未到" |
| 迟到签到 | 晚于签到截止时间 | 提示"已超时，预约已取消" |
| 无预约 | 该座位无当前用户预约 | 提示"您没有该座位的预约" |
| 座位不匹配 | 扫描的不是预约座位 | 提示"座位不匹配" |

### 签到成功页

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│            ┌─────────┐              │
│            │   ✓    │              │
│            │  成功   │              │
│            └─────────┘              │
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │  📍 图书馆 · 2F · 自习室201  │    │
│  │  🪑 17号座位                 │    │
│  │                             │    │
│  │  ⏰ 签到时间：13:58          │    │
│  │  📅 预约结束：18:00          │    │
│  │                             │    │
│  │  祝您学习愉快！              │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         返回首页              │    │
│  └─────────────────────────────┘    │
│                                     │
│                                     │
└─────────────────────────────────────┘
```

---

## 5.3 签退确认页 (Check-out Confirm)

### 页面信息
- **页面路径**：`pages/checkout/confirm`
- **页面参数**：`seatCode` - 座位二维码内容

### 页面布局

```
┌─────────────────────────────────────┐
│  ←      签退确认                    │
├─────────────────────────────────────┤
│                                     │
│            ┌─────────┐              │
│            │  👋    │              │
│            │ 离开图标│              │
│            └─────────┘              │
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │  📍 位置信息                 │    │
│  │  图书馆 · 2F · 自习室201     │    │
│  │                             │    │
│  │  🪑 座位信息                 │    │
│  │  17号座位                    │    │
│  │                             │    │
│  │  ⏰ 本次学习时长              │    │
│  │  2小时35分钟                 │    │
│  │                             │    │
│  │  📊 累计学习时长              │    │
│  │  本周：12小时30分            │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─ 提前签退说明 ─────────────┐    │
│  │ 您的预约时间为 14:00-18:00   │    │
│  │ 当前提前 1小时25分钟 签退    │    │
│  │ 提前释放座位可获得 +1 积分   │    │
│  └─────────────────────────────┘    │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         确认签退              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 签退成功页

```
┌─────────────────────────────────────┐
│                                     │
│                                     │
│            ┌─────────┐              │
│            │   ✓    │              │
│            │  完成   │              │
│            └─────────┘              │
│                                     │
│                                     │
│  ┌─────────────────────────────┐    │
│  │                             │    │
│  │  📊 本次学习报告              │    │
│  │                             │    │
│  │  学习时长：2小时35分钟        │    │
│  │  学习效率：★★★★☆            │    │
│  │                             │    │
│  │  ─────────────────────────  │    │
│  │                             │    │
│  │  🏆 获得成就                 │    │
│  │  "专注学习者" 徽章进度 +10%  │    │
│  │                             │    │
│  │  💰 积分变动                 │    │
│  │  按时履约 +2分               │    │
│  │  提前释放 +1分               │    │
│  │                             │    │
│  └─────────────────────────────┘    │
│                                     │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         返回首页              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

---

## 5.4 临时离开功能

### 触发方式
- 首页预约卡片点击"临时离开"
- 我的预约详情页点击"临时离开"

### 临时离开弹窗

```
┌─────────────────────────────────────┐
│              临时离开          ✕    │
├─────────────────────────────────────┤
│                                     │
│  您确定要临时离开座位吗？            │
│                                     │
│  ⚠️ 临时离开须知：                  │
│  • 离开时间不超过30分钟             │
│  • 超时将自动签退并释放座位          │
│  • 请尽快返回座位                   │
│                                     │
│  ┌─────────┐     ┌─────────┐       │
│  │  取消   │     │ 确认离开 │       │
│  └─────────┘     └─────────┘       │
│                                     │
└─────────────────────────────────────┘
```

### 临时离开状态显示

```
┌─────────────────────────────────────┐
│  我的预约                           │
├─────────────────────────────────────┤
│  ┌─────────────────────────────┐    │
│  │  📍 图书馆 · 2F · 自习室201  │    │
│  │  🪑 17号座位                 │    │
│  │  ⏰ 14:00 - 18:00            │    │
│  │                             │    │
│  │  状态：临时离开中             │    │
│  │  ⏱️ 剩余时间：18:32          │    │
│  │                             │    │
│  │  ┌─────────────────────┐   │    │
│  │  │     返回座位         │   │    │
│  │  └─────────────────────┘   │    │
│  └─────────────────────────────┘    │
└─────────────────────────────────────┘
```

---

## 5.5 异常状态处理

### 相机权限被拒绝

```
┌─────────────────────────────────────┐
│                                     │
│            ┌─────────┐              │
│            │  📷    │              │
│            │ 相机图标│              │
│            └─────────┘              │
│                                     │
│        需要相机权限                  │
│                                     │
│   扫码签到需要使用相机功能，          │
│   请在设置中开启相机权限。           │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         去设置               │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

### 二维码无效

```
┌─────────────────────────────────────┐
│              提示            ✕      │
├─────────────────────────────────────┤
│                                     │
│            ┌─────────┐              │
│            │   ❌   │              │
│            └─────────┘              │
│                                     │
│        无效的二维码                  │
│                                     │
│   请扫描座位上的专属二维码           │
│                                     │
│  ┌─────────────────────────────┐    │
│  │         重新扫描              │    │
│  └─────────────────────────────┘    │
│                                     │
└─────────────────────────────────────┘
```

---

## 5.6 接口依赖

| 接口名称 | 请求方式 | 接口路径 | 说明 |
|----------|----------|----------|------|
| 解析二维码 | POST | `/scan/parse` | 解析座位二维码 |
| 签到 | POST | `/appointment/checkin` | 签到操作 |
| 签退 | POST | `/appointment/checkout` | 签退操作 |
| 临时离开 | POST | `/appointment/leave` | 临时离开 |
| 返回座位 | POST | `/appointment/return` | 返回座位 |

---

> 上一篇：[04-座位预约模块](./04-座位预约模块.md)  
> 下一篇：[06-个人中心模块](./06-个人中心模块.md)
